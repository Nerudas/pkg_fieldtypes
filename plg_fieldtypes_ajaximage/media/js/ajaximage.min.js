(function(a){a(document).ready(function(){a("[data-input-ajaximage]").each(function(){var d=a(this),t=d.attr("id"),f=d.find(".form"),o=f.find('input[type="file"]'),C=d.find(".error.limit"),k=d.find("#"+t+"_progress"),m=k.find(".bar"),p=k.find(".text"),n=d.find("#"+t+"_result");if(!n.selector){n.selector="#"+n.attr("id")}if(!d.selector){d.selector="#"+d.attr("id")}var D=Joomla.getOptions(t,""),I=D.name,B=D.multiple,g=D.subfolder,b=D.saveurl,z=D.uploadurl,E=D.removeurl;if(B){var e=D.unique,q=D.text,x=D.prefix,A=D.limit}else{var u=D.noimage,s=D.image,w=D.filename}k.hide();m.width("0%");p.text("0/0");if(!B){var H="";if(s!==""){H=s}if(H==""&&u!==""){H=u}if(H!==""){H=H+"?v="+Math.random();a(d).find("img").attr("src",H)}}if(B){var r=a(n).find(".item").toArray();if(r.length>0){var y=0,G=r.length;function v(){if(y<G){var i=r[y],J=a(i).find("img").attr("src");a.ajax({url:J,type:"HEAD",error:function(){a(i).remove()},complete:function(){v()}});y++}else{c();h();j()}}v()}j();if(q){a("body").on("change",n.selector+' .item [name*="[text]"]',function(){h()})}a("body").on("click",n.selector+" .item .actions .remove",function(){f.addClass("disable");var i=a(this).parents(".item");var J=i.find('input[name*="[src]"]').val();a.ajax({type:"POST",dataType:"json",global:false,async:false,url:E,data:{src:J},success:function(K){var L=K.data[0];if(L){i.remove();c();h();j()}}});f.removeClass("disable")});a(n.selector).sortable({handle:".actions .move",start:function(i,J){n.addClass("sortable")},stop:function(i,J){c();h();n.removeClass("sortable")}});function c(){n.find(".item").each(function(J,L){var M=a(L).data("key");var K="image";var N=new RegExp(M,"g");a(L).find('[id*="'+K+'_"]').each(function(i,O){var P=a(O).attr("id").replace(N,K+"_"+(J+1));a(O).attr("id",P)});a(L).find('[name*="'+K+'_"]').each(function(i,O){var P=a(O).attr("name").replace(N,K+"_"+(J+1));a(O).attr("name",P)});a(L).attr("data-key",K+"_"+(J+1))})}}else{if(n.val()!==""){var l=a(d).find("img").attr("src");a.ajax({url:l,type:"HEAD",error:function(){n.val("");h();if(u!==""){a(d).find("img").attr("src",u)}else{a(d).find("img").attr("src","")}}})}a("body").on("click",d.selector+" .remove",function(){f.addClass("disable");var i=a(this).parents(".item");var J=n.val();a.ajax({type:"POST",dataType:"json",global:false,async:false,url:E,data:{src:J},success:function(K){var L=K.data[0];if(L){n.val("");h();if(u!==""){a(d).find("img").attr("src",u)}else{a(d).find("img").attr("src","")}}}});f.removeClass("disable")})}o.on("change",function(i){if(!f.hasClass("disable")){F(i.target.files)}});d.on("drag dragstart dragend dragover dragenter dragleave drop",function(i){i.preventDefault();i.stopPropagation()}).on("dragover dragenter",function(){if(!f.hasClass("disable")){f.addClass("dragend")}}).on("dragleave dragend drop",function(){if(!f.hasClass("disable")){f.removeClass("dragend")}}).on("drop",function(i){if(!f.hasClass("disable")){F(i.originalEvent.dataTransfer.files)}});function F(J){if(J){if(!B){J=[J[0]]}var K=d.parents("form").find('[name*="imagefolder"]').val(),R=0,S=J.length,M=0,Q=I,P=t,N=true;var L='<div id="blockUI" style="display: block; position: fixed; top: 0; bottom: 0; left: 0; right: 0; z-index: 999999;"></div>';a("body").append(a(L));m.width("0%");p.text("0/0");k.show();var O=0;function T(){R=R+1;M=R/S*100;if(R<=S){if(j()){var i=new FormData(),U=J[O];i.append("folder",K);i.append("files[]",U);i.append("multiple",B);i.append("subfolder",g);if(B){var V=n.find(".item").length+1;N=j();i.append("text",q);i.append("unique",e);i.append("prefix",x);i.append("key","image_"+V);P=t+"_image_"+V;Q=I.replace("[]","[image_"+V+"]");i.append("fieldname",Q);i.append("fieldid",P)}else{i.append("current",n.val());i.append("filename",w)}a.ajax({type:"POST",dataType:"json",processData:false,contentType:false,url:z,data:i,success:function(W){var X=W.data[0];if(X){if(X.type=="success"){if(B){a(X.html).appendTo(n)}else{n.val(X.value);a(d).find("img").attr("src",X.image)}}}p.text(R+"/"+S);m.width(M+"%");O++;T()}})}else{p.text(R+"/"+S);m.width(M+"%");O++;T()}}else{h();a("#blockUI").remove();k.hide();m.width("0%");p.text("0/0")}}T()}}function j(){var i=false;if(B){if(A==0){i=true}else{var J=n.find(".item").length;if(J<A){i=true}}if(i){f.show();C.hide()}else{f.hide();C.show()}}else{i=true}return i}function h(){var i=new FormData();i.append("multiple",B);if(B){c();n.find(".item").each(function(K,L){var J="value["+a(L).data("key")+"]";i.append(J+"[src]",a(L).find('[name*="[src]"]').val());i.append(J+"[file]",a(L).find('[name*="[file]"]').val());if(q){i.append(J+"[text]",a(L).find('[name*="[text]"]').val())}})}else{i.append("value",n.val())}a.ajax({type:"POST",dataType:"json",processData:false,contentType:false,global:false,async:false,url:b,data:i,success:function(J){}})}})})})(jQuery);