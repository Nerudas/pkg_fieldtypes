(function(a){a(document).ready(function(){a("[data-input-ajaximage]").each(function(){var d=a(this),q=d.attr("id"),f=d.find(".form"),m=f.find('input[type="file"]'),x=d.find(".error.limit"),j=d.find("#"+q+"_progress"),k=j.find(".bar"),n=j.find(".text"),l=d.find("#"+q+"_result");if(!l.selector){l.selector="#"+l.attr("id")}if(!d.selector){d.selector="#"+d.attr("id")}var y=Joomla.getOptions(q,""),C=y.name,w=y.multiple,g=y.subfolder,b=y.saveurl,u=y.uploadurl,z=y.removeurl;if(w){var e=y.unique,o=y.text,t=y.prefix,v=y.limit}else{var r=y.noimage,p=y.image,s=y.filename}j.hide();k.width("0%");n.text("0/0");if(!w){var B="";if(p!==""){B=p}if(B==""&&r!==""){B=r}if(B!==""){B=B+"?v="+Math.random();a(d).find("img").attr("src",B)}}if(w){i();if(o){a("body").on("change",l.selector+' .item [name*="[text]"]',function(){h()})}a("body").on("click",l.selector+" .item .actions .remove",function(){f.addClass("disable");var D=a(this).parents(".item");var E=D.find('input[name*="[src]"]').val();a.ajax({type:"POST",dataType:"json",global:false,async:false,url:z,cache:false,data:{src:E},success:function(F){var G=F.data[0];if(G){D.remove();c();h();i()}}});f.removeClass("disable")});a(l.selector).sortable({handle:".actions .move",start:function(D,E){l.addClass("sortable")},stop:function(D,E){c();h();l.removeClass("sortable")}});function c(){l.find(".item").each(function(D,F){var G=a(F).data("key");var E="image";var H=new RegExp(G,"g");a(F).find('[id*="'+E+'_"]').each(function(I,J){var K=a(J).attr("id").replace(H,E+"_"+(D+1));a(J).attr("id",K)});a(F).find('[name*="'+E+'_"]').each(function(I,J){var K=a(J).attr("name").replace(H,E+"_"+(D+1));a(J).attr("name",K)});a(F).attr("data-key",E+"_"+(D+1))})}}else{a("body").on("click",d.selector+" .remove",function(){f.addClass("disable");var D=a(this).parents(".item");var E=l.val();a.ajax({type:"POST",dataType:"json",global:false,async:false,url:z,cache:false,data:{src:E},success:function(F){var G=F.data[0];if(G){l.val("");h();if(r!==""){a(d).find("img").attr("src",r)}else{a(d).find("img").attr("src","")}}}});f.removeClass("disable")})}m.on("change",function(D){if(!f.hasClass("disable")){A(D.target.files)}});d.on("drag dragstart dragend dragover dragenter dragleave drop",function(D){D.preventDefault();D.stopPropagation()}).on("dragover dragenter",function(){if(!f.hasClass("disable")){f.addClass("dragend")}}).on("dragleave dragend drop",function(){if(!f.hasClass("disable")){f.removeClass("dragend")}}).on("drop",function(D){if(!f.hasClass("disable")){A(D.originalEvent.dataTransfer.files)}});function A(D){if(D){if(!w){D=[D[0]]}var E=d.parents("form").find('[name*="imagefolder"]').val(),L=0,M=D.length,G=0,K=C,J=q,H=true;var F='<div id="blockUI" style="display: block; position: fixed; top: 0; bottom: 0; left: 0; right: 0; z-index: 999999;"></div>';a("body").append(a(F));k.width("0%");n.text("0/0");j.show();var I=0;function N(){L=L+1;G=L/M*100;if(L<=M){if(i()){var O=new FormData(),P=D[I];O.append("folder",E);O.append("files[]",P);O.append("multiple",w);O.append("subfolder",g);if(w){var Q=l.find(".item").length+1;H=i();O.append("text",o);O.append("unique",e);O.append("prefix",t);O.append("key","image_"+Q);J=q+"_image_"+Q;K=C.replace("[]","[image_"+Q+"]");O.append("fieldname",K);O.append("fieldid",J)}else{O.append("current",l.val());O.append("filename",s)}a.ajax({type:"POST",dataType:"json",processData:false,contentType:false,url:u,cache:false,data:O,success:function(R){var S=R.data[0];if(S){if(S.type=="success"){if(w){a(S.html).appendTo(l)}else{l.val(S.value);a(d).find("img").attr("src",S.image)}}}n.text(L+"/"+M);k.width(G+"%");I++;N()}})}else{n.text(L+"/"+M);k.width(G+"%");I++;N()}}else{h();a("#blockUI").remove();j.hide();k.width("0%");n.text("0/0")}}N()}}function i(){var D=false;if(w){if(v==0){D=true}else{var E=l.find(".item").length;if(E<v){D=true}}if(D){f.show();x.hide()}else{f.hide();x.show()}}else{D=true}return D}function h(){var D=new FormData();D.append("multiple",w);if(w){c();l.find(".item").each(function(F,G){var E="value["+a(G).data("key")+"]";D.append(E+"[src]",a(G).find('[name*="[src]"]').val());D.append(E+"[file]",a(G).find('[name*="[file]"]').val());if(o){D.append(E+"[text]",a(G).find('[name*="[text]"]').val())}})}else{D.append("value",l.val())}a.ajax({type:"POST",dataType:"json",processData:false,contentType:false,global:false,async:false,url:b,cache:false,data:D,success:function(E){if(w){i()}}})}})})})(jQuery);