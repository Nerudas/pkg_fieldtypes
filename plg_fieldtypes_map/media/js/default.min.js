(function(a){a(document).ready(function(){a("[data-input-map]").each(function(){var n=a(this),g=a(this).closest("form"),f=n.attr("id"),e,i=false,m=n.find("#"+f+"_map"),l=Joomla.getOptions(f,""),h=l.placemarkurl,d=localStorage.getItem("map");if(d){d=a.parseJSON(d)}else{d={};d.latitude=l.latitude;d.longitude=l.longitude;d.center=l.center;d.zoom=l.zoom;localStorage.setItem("map",JSON.stringify(d))}var k=setInterval(j,3);function j(){a(m).height(Math.round((a(m).width()/4)*3));if(a(m).width()>0&&a(m).height()>0){clearInterval(k);ymaps.ready(c);i=true}}var b={};if(a("#"+f+"_params_center").val()==""){a("#"+f+"_params_center").val(JSON.stringify(d.center))}b.center=a.parseJSON(a("#"+f+"_params_center").val());if(a("#"+f+"_params_latitude").val()==""){a("#"+f+"_params_latitude").val(d.latitude)}b.latitude=a("#"+f+"_params_latitude").val();if(a("#"+f+"_params_longitude").val()==""){a("#"+f+"_params_longitude").val(d.longitude)}b.longitude=a("#"+f+"_params_longitude").val();if(a("#"+f+"_params_zoom").val()==""){a("#"+f+"_params_zoom").val(d.zoom)}b.zoom=a("#"+f+"_params_zoom").val();function c(){e=new ymaps.Map(f+"_map",{center:b.center,zoom:b.zoom,controls:["zoomControl","fullscreenControl","geolocationControl"]});e.behaviors.disable("scrollZoom");var r=new ymaps.control.SearchControl({options:{"float":"left",floatIndex:100,noPlacemark:true}});e.controls.add(r);var q=new ymaps.Placemark([0,0],{},t());function t(){var u={};u.draggable=true;if(h!==""){var v=a(g).serializeArray();a(v).each(function(w,x){if(x.name=="task"){v.splice(w,1)}});a.ajax({type:"POST",dataType:"json",url:h,data:v,global:false,async:false,success:function(w){if(w.success){var x=w.data;a.each(x,function(y,z){if(y=="customLayout"){y="iconLayout";z=ymaps.templateLayoutFactory.createClass(z)}u[y]=z})}}})}else{u.iconLayout="default#image";u.iconImageHref="/media/plg_fieldtypes_map/images/placemark.png";u.iconImageSize=[48,48];u.iconImageOffset=[-24,-48]}return u}a(g).on("change",function(){var u=t();q.options.set(u)});var p=false;if(a("#"+f+"_placemark_coordinates").val()!==""){var s=a.parseJSON(a("#"+f+"_placemark_coordinates").val());e.geoObjects.add(q);q.geometry.setCoordinates(s);p=true}if(!p&&l.setplacemark){var s=e.getCenter();e.geoObjects.add(q);q.geometry.setCoordinates(s);o(s)}e.events.add("click",function(u){var v=u.get("coords");if(e.geoObjects.getLength()==0){e.geoObjects.add(q)}q.geometry.setCoordinates(v);o(v)});q.events.add("dragend",function(){var u=this.geometry.getCoordinates();o(u)},q);q.events.add("contextmenu",function(){e.geoObjects.remove(q);a("#"+f+"_placemark_coordinates").val("");a("#"+f+"_placemark_latitude").val("");a("#"+f+"_placemark_longitude").val("")});r.events.add("resultselect",function(){var u=r.getResultsArray()[0].geometry.getCoordinates();if(e.geoObjects.getLength()==0){e.geoObjects.add(q)}q.geometry.setCoordinates(u);o(u)});function o(v){var w=v[0].toFixed(6),u=v[1].toFixed(6);a("#"+f+"_placemark_coordinates").val(JSON.stringify([w,u]));a("#"+f+"_placemark_latitude").val(w);a("#"+f+"_placemark_longitude").val(u)}e.events.add("boundschange",function(w){if(w.get("newZoom")!=w.get("oldZoom")){var v=w.get("newZoom");b.zoom=v;a("#"+f+"_params_zoom").val(v)}if(w.get("newCenter")!=w.get("oldCenter")){var y=w.get("newCenter")[0].toFixed(6),x=w.get("newCenter")[1].toFixed(6),u=[y,x];b.center=u;b.latitude=y;b.longitude=x;a("#"+f+"_params_center").val(JSON.stringify(u));a("#"+f+"_params_latitude").val(y);a("#"+f+"_params_longitude").val(x)}localStorage.setItem("map",JSON.stringify(b))})}})})})(jQuery);