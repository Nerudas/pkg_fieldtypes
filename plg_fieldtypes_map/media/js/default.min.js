(function(a){a(document).ready(function(){a("[data-input-map]").each(function(){var n=a(this),g=a(this).closest("form"),f=n.attr("id"),e,i=false,m=n.find("#"+f+"_map"),l=Joomla.getOptions(f,""),h=l.placemarkurl,d=localStorage.getItem("map");if(d){d=a.parseJSON(d)}else{d={};d.latitude=l.latitude;d.longitude=l.longitude;d.center=l.center;d.zoom=l.zoom;localStorage.setItem("map",JSON.stringify(d))}var k=setInterval(j,3);function j(){a(m).height(Math.round((a(m).width()/4)*3));if(a(m).width()>0&&a(m).height()>0){clearInterval(k);ymaps.ready(c);i=true}}var b={};if(a("#"+f+"_params_center").val()==""){a("#"+f+"_params_center").val(JSON.stringify(d.center))}b.center=a.parseJSON(a("#"+f+"_params_center").val());if(a("#"+f+"_params_latitude").val()==""){a("#"+f+"_params_latitude").val(d.latitude)}b.latitude=a("#"+f+"_params_latitude").val();if(a("#"+f+"_params_longitude").val()==""){a("#"+f+"_params_longitude").val(d.longitude)}b.longitude=a("#"+f+"_params_longitude").val();if(a("#"+f+"_params_zoom").val()==""){a("#"+f+"_params_zoom").val(d.zoom)}b.zoom=a("#"+f+"_params_zoom").val();function c(){e=new ymaps.Map(f+"_map",{center:b.center,zoom:b.zoom,controls:["zoomControl","fullscreenControl","geolocationControl"]});e.behaviors.disable("scrollZoom");var q=new ymaps.control.SearchControl({options:{"float":"left",floatIndex:100,noPlacemark:true}});e.controls.add(q);var p=new ymaps.Placemark([0,0],{},s());function s(){var t={};t.draggable=true;if(h!==""){var u=a(g).serializeArray();a(u).each(function(v,w){if(w.name=="task"){u.splice(v,1)}});a.ajax({type:"POST",dataType:"json",url:h,data:u,global:false,async:false,success:function(v){if(v.success){var w=v.data;a.each(w,function(x,y){if(x=="customLayout"){x="iconLayout";y=ymaps.templateLayoutFactory.createClass(y)}t[x]=y})}}})}else{t.iconLayout="default#image";t.iconImageHref="/media/plg_fieldtypes_map/images/placemark.png";t.iconImageSize=[48,48];t.iconImageOffset=[-24,-48]}return t}a(g).on("change",function(){var t=s();p.options.set(t)});if(a("#"+f+"_placemark_coordinates").val()!==""){var r=a.parseJSON(a("#"+f+"_placemark_coordinates").val());e.geoObjects.add(p);p.geometry.setCoordinates(r)}e.events.add("click",function(t){var u=t.get("coords");if(e.geoObjects.getLength()==0){e.geoObjects.add(p)}p.geometry.setCoordinates(u);o(u)});p.events.add("dragend",function(){var t=this.geometry.getCoordinates();o(t)},p);p.events.add("contextmenu",function(){e.geoObjects.remove(p);a("#"+f+"_placemark_coordinates").val("");a("#"+f+"_placemark_latitude").val("");a("#"+f+"_placemark_longitude").val("")});q.events.add("resultselect",function(){var t=q.getResultsArray()[0].geometry.getCoordinates();if(e.geoObjects.getLength()==0){e.geoObjects.add(p)}p.geometry.setCoordinates(t);o(t)});function o(u){var v=u[0].toFixed(6),t=u[1].toFixed(6);a("#"+f+"_placemark_coordinates").val(JSON.stringify([v,t]));a("#"+f+"_placemark_latitude").val(v);a("#"+f+"_placemark_longitude").val(t)}e.events.add("boundschange",function(v){if(v.get("newZoom")!=v.get("oldZoom")){var u=v.get("newZoom");b.zoom=u;a("#"+f+"_params_zoom").val(u)}if(v.get("newCenter")!=v.get("oldCenter")){var x=v.get("newCenter")[0].toFixed(6),w=v.get("newCenter")[1].toFixed(6),t=[x,w];b.center=t;b.latitude=x;b.longitude=w;a("#"+f+"_params_center").val(JSON.stringify(t));a("#"+f+"_params_latitude").val(x);a("#"+f+"_params_longitude").val(w)}localStorage.setItem("map",JSON.stringify(b))})}})})})(jQuery);